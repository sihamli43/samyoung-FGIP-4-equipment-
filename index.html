<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SAMYOUNG FGIP -4 Equipment Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { margin: 0; background: #f3f4f6; color: #111827; }
    .app { max-width: 1200px; margin: 0 auto; padding: 16px; }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    header h1 { margin: 0; font-size: 1.7rem; display: flex; align-items: center; gap: 10px; }

    header img { height: 50px; border-radius: 6px; }

    .card { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 16px; }

    .stats { display: flex; gap: 16px; flex-wrap: wrap; }
    .stat-card { flex: 1; background:#eff6ff; border-radius:10px; padding:12px; min-width:150px; }

    .layout { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; }
    @media(max-width:800px){ .layout{ grid-template-columns:1fr; } }

    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; }
    tr:hover { background:#eef2ff; cursor:pointer; }

    .thumb {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
    }

    .details-body { display:grid; grid-template-columns:1.2fr 2fr; gap:16px; }
    @media(max-width:600px){ .details-body{ grid-template-columns:1fr; } }

    .vehicle-image { width: 100%; border-radius:10px; object-fit:cover; max-height:220px; background:#e5e7eb; }

    .detail-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    label { font-size:0.8rem; margin-bottom:2px; display:block; }
    input { width:100%; padding:6px; border:1px solid #ccc; border-radius:6px; }

    .btn { padding:8px 14px; border:none; border-radius:20px; cursor:pointer; }
    .btn-primary { background:#2563eb; color:white; }
    .btn-ghost { background:transparent; color:#555; }

    @media print {
      body * { visibility: hidden; }
      #detailsCard, #detailsCard * { visibility: visible; }
      #detailsCard { position:absolute; inset:0; margin:0; }
    }
  </style>
</head>

<body>

<!-- Login Screen -->
<div id="loginScreen" style="position:fixed; inset:0; background:#f3f4f6; display:flex; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px; border-radius:12px; width:300px;">
    <h2 style="text-align:center; margin-top:0;">Login</h2>
    <label>Username</label>
    <input id="loginUser">
    <label>Password</label>
    <input id="loginPass" type="password">
    <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; margin-top:12px;">Login</button>
    <p id="loginError" style="color:red; text-align:center; display:none;">Invalid login</p>
  </div>
</div>

<!-- Main App -->
<div class="app" id="mainApp" style="display:none;">

  <header>
    <h1>
      <img src="assets/logo.png" alt="Samyoung Logo">
      SAMYOUNG FGIP -4
    </h1>
    <span>Using online database (Firestore)</span>
  </header>

  <div class="card stats">
    <div class="stat-card">
      <div>Total Vehicles</div>
      <div id="totalVehicles" style="font-size:1.4rem;font-weight:700;">0</div>
    </div>
    <div class="stat-card">
      <div>Upcoming Service</div>
      <div id="needsService" style="font-size:1.4rem;font-weight:700;">0</div>
    </div>
  </div>

  <div class="layout">
    
    <!-- LEFT SIDE -->
    <div>
      <div class="card">
        <h3>Vehicle List</h3>

        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Driver</th>
              <th>Plate</th>
              <th>Next Service</th>
            </tr>
          </thead>
          <tbody id="vehicleTableBody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Add New Vehicle</h3>

        <form id="vehicleForm">
          <label>Name *</label><input id="name" required>
          <label>Plate *</label><input id="plate" required>
          <label>Driver</label><input id="driver">
          <label>Iqama</label><input id="iqama">
          <label>License</label><input id="license">
          <label>Inspection Date</label><input id="inspectionDate" type="date">
          <label>Inspection Expiry Date</label><input id="expiryDate" type="date">
          <label>Medical Fitness Expiry Date</label><input id="medicalExpiryDate" type="date">
          <label>Last Service Date</label><input id="serviceDate" type="date">
          <label>Next Service Date</label><input id="nextServiceDate" type="date">
          <label>Photo</label><input id="image" type="file" accept="image/*">
          <label>Documents</label><input id="docs" type="file" multiple>

          <button class="btn btn-primary" style="margin-top:10px;">Add Vehicle</button>
        </form>

      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div>
      <div class="card" id="detailsCard">
        <h3 id="detailsTitle">No vehicle selected</h3>
        <p id="detailsSubtitle">Select a vehicle from the list</p>

        <button onclick="deleteVehicle()" class="btn btn-ghost">Delete</button>
        <button onclick="printDetails()" class="btn btn-primary">Print</button>

        <div id="detailsBody" style="display:none;">

          <img id="detailsImage" class="vehicle-image">

          <div class="detail-grid">
            <div><strong>Driver:</strong> <span id="detailsDriver"></span></div>
            <div><strong>Plate:</strong> <span id="detailsPlate"></span></div>
            <div><strong>Iqama:</strong> <span id="detailsIqama"></span></div>
            <div><strong>License:</strong> <span id="detailsLicense"></span></div>
            <div><strong>Inspection:</strong> <span id="detailsInspection"></span></div>
            <div><strong>Inspection Expiry:</strong> <span id="detailsExpiry"></span></div>
            <div><strong>Medical Fitness Expiry:</strong> <span id="detailsMedicalExpiry"></span></div>
            <div><strong>Last Service:</strong> <span id="detailsService"></span></div>
            <div><strong>Next Service:</strong> <span id="detailsNextService"></span></div>
          </div>

          <h4>Documents</h4>
          <ul id="detailsDocs"></ul>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- FIREBASE MODULE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwAMnqkJz9uifaaKETPTyFkIzhPfjQfEs",
  authDomain: "samyoung-equipment.firebaseapp.com",
  projectId: "samyoung-equipment",
  storageBucket: "samyoung-equipment.firebasestorage.app",
  messagingSenderId: "1085341907778",
  appId: "1:1085341907778:web:0d7172ab61bcfbaf52a6db",
  measurementId: "G-DZ095FKLSS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const vehiclesCol = collection(db, "vehicles");

async function dbLoadVehicles() {
  const snap = await getDocs(vehiclesCol);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

async function dbAddVehicle(data) {
  const ref = await addDoc(vehiclesCol, data);
  return { ...data, id: ref.id };
}

async function dbDeleteVehicle(id) {
  await deleteDoc(doc(vehiclesCol, id));
}

window.dbApi = { dbLoadVehicles, dbAddVehicle, dbDeleteVehicle };
</script>

<!-- MAIN APP LOGIC -->
<script>
let vehicles = [];
let currentVehicleId = null;

function attemptLogin(){
  if (loginUser.value === "samyoung" && loginPass.value === "FGIP-4") {
    loginScreen.style.display = "none";
    mainApp.style.display = "block";
  } else {
    loginError.style.display = "block";
  }
}

function renderStats() {
  document.getElementById("totalVehicles").textContent = vehicles.length;
  document.getElementById("needsService").textContent =
    vehicles.filter(v => v.nextServiceDate).length;
}

function renderList() {
  const tbody = document.getElementById("vehicleTableBody");
  tbody.innerHTML = "";

  vehicles.forEach(v => {
    const tr = document.createElement("tr");
    tr.dataset.id = v.id;

    const photoHtml = v.imageDataUrl
      ? `<img src="${v.imageDataUrl}" class="thumb">`
      : "—";

    tr.innerHTML = `
      <td>${photoHtml}</td>
      <td>${v.name || "—"}</td>
      <td>${v.driver || "—"}</td>
      <td>${v.plate || "—"}</td>
      <td>${v.nextServiceDate || "—"}</td>
    `;

    tr.onclick = () => showDetails(v.id);
    tbody.appendChild(tr);
  });
}

function showDetails(id) {
  const v = vehicles.find(x => x.id === id);
  if (!v) return;

  currentVehicleId = id;

  detailsTitle.textContent = v.name;
  detailsDriver.textContent = v.driver || "—";
  detailsPlate.textContent = v.plate || "—";
  detailsIqama.textContent = v.iqama || "—";
  detailsLicense.textContent = v.license || "—";
  detailsInspection.textContent = v.inspectionDate || "—";
  detailsExpiry.textContent = v.expiryDate || "—";
  detailsMedicalExpiry.textContent = v.medicalExpiryDate || "—";
  detailsService.textContent = v.serviceDate || "—";
  detailsNextService.textContent = v.nextServiceDate || "—";

  if (v.imageDataUrl) {
    detailsImage.src = v.imageDataUrl;
    detailsImage.style.display = "block";
  }

  const docsList = document.getElementById("detailsDocs");
  docsList.innerHTML = "";
  if (v.docs && v.docs.length) {
    v.docs.forEach(d => {
      const li = document.createElement("li");
      li.innerHTML = `<a href="${d.dataUrl}" target="_blank">${d.name}</a>`;
      docsList.appendChild(li);
    });
  }

  detailsBody.style.display = "block";
}

function deleteVehicle() {
  if (!currentVehicleId) return;

  const v = vehicles.find(x => x.id === currentVehicleId);
  if (!confirm("Delete " + v.name + "?")) return;

  window.dbApi.dbDeleteVehicle(currentVehicleId).then(() => {
    vehicles = vehicles.filter(x => x.id !== currentVehicleId);
    renderList();
    renderStats();
    detailsBody.style.display = "none";
    detailsTitle.textContent = "No vehicle selected";
  });
}

function handleFormSubmit(e){
  e.preventDefault();

  const name = document.getElementById("name").value;
  const plate = document.getElementById("plate").value;
  const driver = document.getElementById("driver").value;
  const iqama = document.getElementById("iqama").value;
  const license = document.getElementById("license").value;
  const inspectionDate = inspectionDate.value;
  const expiryDate = expiryDate.value;
  const medicalExpiryDate = medicalExpiryDate.value;
  const serviceDate = serviceDate.value;
  const nextServiceDate = nextServiceDate.value;

  const imageFile = image.files[0];
  const docsFiles = docs.files;

  function finishAdd(imageDataUrl, docsArr) {
    const data = {
      name, plate, driver, iqama, license,
      inspectionDate, expiryDate, medicalExpiryDate,
      serviceDate, nextServiceDate,
      imageDataUrl, docs: docsArr
    };

    window.dbApi.dbAddVehicle(data).then(saved => {
      vehicles.push(saved);
      renderList();
      renderStats();
      showDetails(saved.id);
    });

    e.target.reset();
  }

  function readFiles(files, callback) {
    const arr = [];
    let remaining = files.length;
    if (!remaining) return callback([]);

    for (const f of files) {
      const r = new FileReader();
      r.onload = () => {
        arr.push({ name: f.name, dataUrl: r.result });
        if (--remaining === 0) callback(arr);
      };
      r.readAsDataURL(f);
    }
  }

  if (imageFile) {
    const reader = new FileReader();
    reader.onload = (ev) => {
      readFiles(docsFiles, (docsArr) => {
        finishAdd(ev.target.result, docsArr);
      });
    };
    reader.readAsDataURL(imageFile);
  } else {
    readFiles(docsFiles, (docsArr) => {
      finishAdd(null, docsArr);
    });
  }
}

document.getElementById("vehicleForm").onsubmit = handleFormSubmit;

document.addEventListener("DOMContentLoaded", () => {
  window.dbApi.dbLoadVehicles().then(list => {
    vehicles = list;
    renderStats();
    renderList();
  });
});
</script>

</body>
</html>

