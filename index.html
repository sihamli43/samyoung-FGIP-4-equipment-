<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAMYOUNG FGIP -4 Equipment Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { margin: 0; background: #f3f4f6; color: #111827; }
    .app { max-width: 1200px; margin: 0 auto; padding: 16px; }

    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    header h1 { display: flex; align-items: center; gap: 10px; margin: 0; }
    header img { height: 50px; }

    .card { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 16px; }

    .stats { display: flex; gap: 16px; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #eff6ff; padding: 12px; border-radius: 10px; min-width: 150px; }

    .layout { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; }
    @media(max-width:800px) { .layout { grid-template-columns: 1fr; } }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; }
    tr:hover { background: #eef2ff; cursor: pointer; }

    .thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }

    .vehicle-image { width: 100%; height: 220px; object-fit: cover; border-radius: 10px; background: #e5e7eb; }

    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

    .btn { padding: 8px 14px; border-radius: 20px; border: none; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-ghost { background: transparent; color: #444; }
  </style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed; inset:0; background:#f3f4f6; display:flex; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px; width:300px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
    <h2 style="text-align:center; margin-top:0;">Login</h2>

    <label>Username</label>
    <input id="loginUser" style="width:100%; margin-bottom:10px;">

    <label>Password</label>
    <input id="loginPass" type="password" style="width:100%; margin-bottom:10px;">

    <button class="btn btn-primary" onclick="attemptLogin()" style="width:100%;">Login</button>

    <p id="loginError" style="color:red; text-align:center; display:none;">Invalid login</p>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none;">

  <header>
    <h1><img src="assets/logo.png" alt="Logo"> SAMYOUNG FGIP -4</h1>
    <span style="opacity:0.7;">Using Online Database (Firestore)</span>
  </header>

  <div class="card stats">
    <div class="stat-card"><div>Total Vehicles</div><div id="totalVehicles" style="font-size:1.3rem;font-weight:700;">0</div></div>
    <div class="stat-card"><div>Upcoming Service</div><div id="needsService" style="font-size:1.3rem;font-weight:700;">0</div></div>
  </div>

  <div class="layout">

    <!-- LEFT COLUMN -->
    <div>
      <div class="card">
        <h3>Vehicle List</h3>

        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Driver</th>
              <th>Plate</th>
              <th>Next Service</th>
            </tr>
          </thead>
          <tbody id="vehicleTableBody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Add New Vehicle</h3>

        <form id="vehicleForm">
          <label>Name *</label><input id="name" required>
          <label>Plate *</label><input id="plate" required>
          <label>Driver</label><input id="driver">
          <label>Iqama</label><input id="iqama">
          <label>License</label><input id="license">
          <label>Inspection Date</label><input id="inspectionDate" type="date">
          <label>Inspection Expiry</label><input id="expiryDate" type="date">
          <label>Medical Fitness Expiry</label><input id="medicalExpiryDate" type="date">
          <label>Last Service Date</label><input id="serviceDate" type="date">
          <label>Next Service Date</label><input id="nextServiceDate" type="date">
          <label>Photo</label><input id="image" type="file" accept="image/*">
          <label>Documents</label><input id="docs" type="file" multiple>

          <button class="btn btn-primary" style="margin-top:10px;">Add Vehicle</button>
        </form>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <div class="card" id="detailsCard">
        <h3 id="detailsTitle">No vehicle selected</h3>
        <p id="detailsSubtitle">Select a vehicle to view details</p>

        <button class="btn btn-ghost" onclick="deleteVehicle()">Delete</button>
        <button class="btn btn-primary" onclick="window.print()">Print</button>

        <div id="detailsBody" style="display:none; margin-top:10px;">
          <img id="detailsImage" class="vehicle-image">

          <div class="detail-grid">
            <div><strong>Driver:</strong> <span id="detailsDriver"></span></div>
            <div><strong>Plate:</strong> <span id="detailsPlate"></span></div>
            <div><strong>Iqama:</strong> <span id="detailsIqama"></span></div>
            <div><strong>License:</strong> <span id="detailsLicense"></span></div>
            <div><strong>Inspection:</strong> <span id="detailsInspection"></span></div>
            <div><strong>Inspection Expiry:</strong> <span id="detailsExpiry"></span></div>
            <div><strong>Medical Fitness Expiry:</strong> <span id="detailsMedicalExpiry"></span></div>
            <div><strong>Last Service:</strong> <span id="detailsService"></span></div>
            <div><strong>Next Service:</strong> <span id="detailsNextService"></span></div>
          </div>

          <h4>Documents</h4>
          <ul id="detailsDocs"></ul>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- FIREBASE MODULE SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwAMnqkJz9uifaaKETPTyFkIzhPfjQfEs",
  authDomain: "samyoung-equipment.firebaseapp.com",
  projectId: "samyoung-equipment",
  storageBucket: "samyoung-equipment.firebasestorage.app",
  messagingSenderId: "1085341907778",
  appId: "1:1085341907778:web:0d7172ab61bcfbaf52a6db",
  measurementId: "G-DZ095FKLSS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const vehiclesCol = collection(db, "vehicles");

async function dbLoadVehicles() {
  const snap = await getDocs(vehiclesCol);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

async function dbAddVehicle(data) {
  const ref = await addDoc(vehiclesCol, data);
  return { ...data, id: ref.id };
}

async function dbDeleteVehicle(id) {
  await deleteDoc(doc(vehiclesCol, id));
}

window.dbApi = { dbLoadVehicles, dbAddVehicle, dbDeleteVehicle };
</script>

<!-- MAIN LOGIC -->
<script>
let vehicles = [];
let currentVehicleId = null;

function attemptLogin() {
  if (loginUser.value === "samyoung" && loginPass.value === "FGIP-4") {
    loginScreen.style.display = "none";
    mainApp.style.display = "block";
  } else {
    loginError.style.display = "block";
  }
}

function renderStats() {
  totalVehicles.textContent = vehicles.length;
  needsService.textContent = vehicles.filter(v => v.nextServiceDate).length;
}

function renderList() {
  vehicleTableBody.innerHTML = "";

  vehicles.forEach(v => {
    const tr = document.createElement("tr");
    tr.dataset.id = v.id;

    tr.innerHTML = `
      <td>${v.imageDataUrl ? `<img class="thumb" src="${v.imageDataUrl}">` : "—"}</td>
      <td>${v.name}</td>
      <td>${v.driver || "—"}</td>
      <td>${v.plate}</td>
      <td>${v.nextServiceDate || "—"}</td>
    `;
    tr.onclick = () => showDetails(v.id);
    vehicleTableBody.appendChild(tr);
  });
}

function showDetails(id) {
  const v = vehicles.find(x => x.id === id);
  if (!v) return;

  currentVehicleId = id;

  detailsTitle.textContent = v.name;
  detailsDriver.textContent = v.driver || "—";
  detailsPlate.textContent = v.plate || "—";
  detailsIqama.textContent = v.iqama || "—";
  detailsLicense.textContent = v.license || "—";
  detailsInspection.textContent = v.inspectionDate || "—";
  detailsExpiry.textContent = v.expiryDate || "—";
  detailsMedicalExpiry.textContent = v.medicalExpiryDate || "—";
  detailsService.textContent = v.serviceDate || "—";
  detailsNextService.textContent = v.nextServiceDate || "—";

  detailsImage.src = v.imageDataUrl || "";

  detailsDocs.innerHTML = "";
  if (v.docs && v.docs.length) {
    v.docs.forEach(d => {
      const li = document.createElement("li");
      li.innerHTML = `<a href="${d.dataUrl}" target="_blank">${d.name}</a>`;
      detailsDocs.appendChild(li);
    });
  }

  detailsBody.style.display = "block";
}

function deleteVehicle() {
  if (!currentVehicleId) return;

  const v = vehicles.find(x => x.id === currentVehicleId);
  if (!confirm("Delete " + v.name + "?")) return;

  window.dbApi.dbDeleteVehicle(currentVehicleId).then(() => {
    vehicles = vehicles.filter(x => x.id !== currentVehicleId);
    renderList();
    renderStats();
    detailsBody.style.display = "none";
    detailsTitle.textContent = "No vehicle selected";
  });
}

function handleFormSubmit(e) {
  e.preventDefault();

  const data = {
    name: name.value,
    plate: plate.value,
    driver: driver.value,
    iqama: iqama.value,
    license: license.value,
    inspectionDate: inspectionDate.value,
    expiryDate: expiryDate.value,
    medicalExpiryDate: medicalExpiryDate.value,
    serviceDate: serviceDate.value,
    nextServiceDate: nextServiceDate.value,
    imageDataUrl: null,
    docs: []
  };

  const img = image.files[0];
  const docFiles = docs.files;

  function saveFinal() {
    window.dbApi.dbAddVehicle(data).then(saved => {
      vehicles.push(saved);
      renderList();
      renderStats();
      showDetails(saved.id);
    });
    vehicleForm.reset();
  }

  function readDocs(done) {
    let out = [];
    if (!docFiles.length) return done(out);

    let remaining = docFiles.length;
    for (const file of docFiles) {
      const r = new FileReader();
      r.onload = () => {
        out.push({ name: file.name, dataUrl: r.result });
        if (--remaining === 0) done(out);
      };
      r.readAsDataURL(file);
    }
  }

  function readImage(next) {
    if (!img) return next(null);

    const reader = new FileReader();
    reader.onload = () => next(reader.result);
    reader.readAsDataURL(img);
  }

  readImage(imgUrl => {
    data.imageDataUrl = imgUrl;

    readDocs(docArr => {
      data.docs = docArr;
      saveFinal();
    });
  });
}

vehicleForm.onsubmit = handleFormSubmit;

document.addEventListener("DOMContentLoaded", () => {
  window.dbApi.dbLoadVehicles().then(list => {
    vehicles = list;
    renderStats();
    renderList();
  });
});
</script>

</body>
</html>


