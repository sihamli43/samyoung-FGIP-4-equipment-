<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SAMYOUNG FGIP -4 Equipment Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }

    body {
      margin: 0;
      background: #F5F6FA;
      color: #0A0E2A;
    }

    /* Login Page */
    #loginScreen {
      position: fixed;
      inset: 0;
      background: #F3F4F6;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #loginScreen .box {
      background: white;
      padding: 24px;
      width: 300px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    #loginScreen input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .btn {
      padding: 10px 18px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: #D62828;
      color: white;
    }

    .btn-ghost {
      background: transparent;
      color: #D62828;
      border: 1px solid #D62828;
    }

    /* Main Layout */
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    header h1 {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      font-size: 1.8rem;
      color: #0A0E2A;
    }

    header img {
      height: 55px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #EFF2FF;
      padding: 16px;
      border-radius: 10px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    tr:hover {
      background: #F2F6FF;
      cursor: pointer;
    }

    .thumb {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
    }

    input {
      padding: 8px;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .vehicle-image {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      background: #EEE;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 8px;
    }

    #nextInspectionSummary {
      font-size: 0.95rem;
      margin-top: 4px;
      font-weight: 600;
    }

    #nextInspectionList {
      font-size: 0.8rem;
      margin-top: 6px;
      color: #4B5563;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="box">
    <h2 style="text-align:center; margin-top:0;">Login</h2>

    <label>Username</label>
    <input id="loginUser">

    <label>Password</label>
    <input id="loginPass" type="password">

    <button id="loginBtn" class="btn btn-primary" style="width:100%;">Login</button>

    <p id="loginError" style="color:red; text-align:center; display:none;">Invalid login</p>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="mainApp" style="display:none;">

  <header>
    <h1><img src="assets/logo.png" alt="Logo">SAMYOUNG FGIP -4</h1>
    <span style="opacity:0.7;">Using Online Database (Firestore)</span>
  </header>

  <!-- DASHBOARD STATS -->
  <div class="stats">
    <div class="stat-card">
      <div>Total Vehicles</div>
      <div id="totalVehicles" style="font-size:1.6rem; font-weight:700;">0</div>
    </div>

    <div class="stat-card">
      <div>Closest Inspection</div>
      <div id="nextInspectionSummary">No inspection dates set</div>
      <div id="nextInspectionList"></div>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT SIDE -->
    <div>
      <div class="card">
        <h3>Vehicle List</h3>
        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Driver Name</th>
              <th>Vehicle / Equipment</th>
              <th>Plate</th>
              <th>Next Service</th>
            </tr>
          </thead>
          <tbody id="vehicleTableBody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3 id="vehicleFormTitle">Add New Vehicle</h3>

        <form id="vehicleForm">
          <label>Driver Name *</label>
          <input id="driverName" required>

          <label>Plate *</label>
          <input id="plate" required>

          <label>Vehicle / Equipment</label>
          <input id="driver">

          <label>Iqama</label>
          <input id="iqama">

          <label>License</label>
          <input id="license">

          <label>Inspection Date</label>
          <input id="inspectionDate" type="date">

          <label>Inspection Expiry</label>
          <input id="expiryDate" type="date">

          <label>Medical Fitness Expiry</label>
          <input id="medicalExpiryDate" type="date">

          <label>Last Service Date</label>
          <input id="serviceDate" type="date">

          <label>Next Service Date</label>
          <input id="nextServiceDate" type="date">

          <label>Photos (you can select 3–4)</label>
          <input id="image" type="file" accept="image/*" multiple>

          <label>Documents (PDF / images, multiple)</label>
          <input id="docs" type="file" multiple>

          <button id="submitBtn" class="btn btn-primary" style="margin-top:10px;">Add Vehicle</button>
        </form>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div>
      <div class="card" id="detailsCard">
        <h3 id="detailsTitle">No vehicle selected</h3>
        <p id="detailsSubtitle">Select a vehicle to view details</p>

        <div style="display:flex; gap:8px; margin-bottom:10px;">
          <button class="btn btn-ghost" type="button" onclick="startEdit()">Edit</button>
          <button class="btn btn-ghost" type="button" onclick="deleteVehicle()">Delete</button>
          <button class="btn btn-primary" type="button" onclick="window.print()">Print</button>
        </div>

        <div id="detailsBody" style="margin-top:10px; display:none;">

          <!-- MULTIPLE IMAGES -->
          <div id="detailsImages"></div>

          <div class="detail-grid">

            <div><strong>Vehicle / Equipment:</strong> <span id="detailsDriver"></span></div>
            <div><strong>Driver Name:</strong> <span id="detailsDriverName"></span></div>

            <div><strong>Plate:</strong> <span id="detailsPlate"></span></div>
            <div><strong>Iqama:</strong> <span id="detailsIqama"></span></div>

            <div><strong>License:</strong> <span id="detailsLicense"></span></div>
            <div><strong>Inspection:</strong> <span id="detailsInspection"></span></div>

            <div><strong>Inspection Expiry:</strong> <span id="detailsExpiry"></span></div>
            <div><strong>Medical Fitness Expiry:</strong> <span id="detailsMedicalExpiry"></span></div>

            <div><strong>Last Service:</strong> <span id="detailsService"></span></div>
            <div><strong>Next Service:</strong> <span id="detailsNextService"></span></div>

          </div>

          <h4>Documents</h4>
          <ul id="detailsDocs"></ul>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc }
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwAMnqkJz9uifaaKETPTyFkIzhPfjQfEs",
  authDomain: "samyoung-equipment.firebaseapp.com",
  projectId: "samyoung-equipment",
  storageBucket: "samyoung-equipment.firebasestorage.app",
  messagingSenderId: "1085341907778",
  appId: "1:1085341907778:web:0d7172ab61bcfbaf52a6db",
  measurementId: "G-DZ095FKLSS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const vehiclesCol = collection(db, "vehicles");

async function dbLoadVehicles() {
  const snap = await getDocs(vehiclesCol);
  return snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

async function dbAddVehicle(data) {
  const ref = await addDoc(vehiclesCol, data);
  return { ...data, id: ref.id };
}

async function dbDeleteVehicle(id) {
  await deleteDoc(doc(vehiclesCol, id));
}

async function dbUpdateVehicle(id, data) {
  const ref = doc(vehiclesCol, id);
  await updateDoc(ref, data);
}

window.dbApi = { dbLoadVehicles, dbAddVehicle, dbDeleteVehicle, dbUpdateVehicle };
</script>

<!-- MAIN LOGIC -->
<script>
let vehicles = [];
let currentVehicleId = null;
let isEditing = false;
let editingId = null;

/* LOGIN */
document.getElementById("loginBtn").onclick = function () {
  if (loginUser.value === "samyoung" && loginPass.value === "FGIP-4") {
    loginScreen.style.display = "none";
    mainApp.style.display = "block";
  } else {
    loginError.style.display = "block";
  }
};

/* LOAD VEHICLES */
document.addEventListener("DOMContentLoaded", () => {
  window.dbApi.dbLoadVehicles().then(list => {
    vehicles = list;
    renderList();
    renderStats();
  });
});

/* STATS */
function renderStats() {
  const totalEl = document.getElementById('totalVehicles');
  const summaryEl = document.getElementById('nextInspectionSummary');
  const listEl = document.getElementById('nextInspectionList');

  if (totalEl) totalEl.textContent = vehicles.length;

  if (!summaryEl || !listEl) return;

  const upcoming = vehicles
    .filter(v => v.inspectionDate)
    .map(v => ({
      ...v,
      inspectionDateObj: new Date(v.inspectionDate)
    }))
    .filter(v => !isNaN(v.inspectionDateObj.getTime()))
    .sort((a, b) => a.inspectionDateObj - b.inspectionDateObj);

  if (upcoming.length === 0) {
    summaryEl.textContent = "No inspection dates set";
    listEl.textContent = "";
    return;
  }

  const first = upcoming[0];
  const dateStr = first.inspectionDate;
  summaryEl.textContent = `${dateStr} – ${first.name || first.driver || first.plate || "Vehicle"}`;

  const extra = upcoming.slice(1, 3);
  if (extra.length) {
    listEl.textContent = extra
      .map(v => `${v.inspectionDate}: ${v.name || v.driver || v.plate || "Vehicle"}`)
      .join(" | ");
  } else {
    listEl.textContent = "";
  }
}

/* RENDER TABLE */
function renderList() {
  vehicleTableBody.innerHTML = "";

  vehicles.forEach(v => {
    const firstImage = v.images && v.images.length ? v.images[0].dataUrl : null;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${firstImage ? `<img class="thumb" src="${firstImage}">` : "—"}</td>
      <td>${v.name}</td>
      <td>${v.driver || "—"}</td>
      <td>${v.plate}</td>
      <td>${v.nextServiceDate || "—"}</td>
    `;
    tr.onclick = () => showDetails(v.id);
    vehicleTableBody.appendChild(tr);
  });
}

/* SHOW DETAILS */
function showDetails(id) {
  const v = vehicles.find(x => x.id === id);
  if (!v) return;

  currentVehicleId = v.id;

  detailsTitle.textContent = v.name;
  detailsDriver.textContent = v.driver || "—";
  detailsDriverName.textContent = v.name || "—";
  detailsPlate.textContent = v.plate || "—";

  detailsIqama.textContent = v.iqama || "—";
  detailsLicense.textContent = v.license || "—";

  detailsInspection.textContent = v.inspectionDate || "—";
  detailsExpiry.textContent = v.expiryDate || "—";
  detailsMedicalExpiry.textContent = v.medicalExpiryDate || "—";

  detailsService.textContent = v.serviceDate || "—";
  detailsNextService.textContent = v.nextServiceDate || "—";

  // IMAGES
  const imagesContainer = document.getElementById('detailsImages');
  imagesContainer.innerHTML = "";
  if (v.images && v.images.length) {
    v.images.forEach(img => {
      const a = document.createElement('a');
      a.href = img.dataUrl;
      a.target = "_blank";
      a.download = img.name || "photo";
      const imageEl = document.createElement('img');
      imageEl.src = img.dataUrl;
      imageEl.className = "vehicle-image";
      a.appendChild(imageEl);
      imagesContainer.appendChild(a);
    });
  } else {
    imagesContainer.textContent = "No photos uploaded";
  }

  // DOCUMENTS
  detailsDocs.innerHTML = "";
  if (v.docs && v.docs.length) {
    v.docs.forEach(d => {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.href = d.dataUrl;
      a.target = "_blank";
      a.download = d.name || "document";
      a.textContent = d.name || "Document";
      li.appendChild(a);
      detailsDocs.appendChild(li);
    });
  } else {
    const li = document.createElement("li");
    li.textContent = "No documents uploaded";
    detailsDocs.appendChild(li);
  }

  detailsBody.style.display = "block";
}

/* START EDIT */
function startEdit() {
  if (!currentVehicleId) return;
  const v = vehicles.find(x => x.id === currentVehicleId);
  if (!v) return;

  isEditing = true;
  editingId = v.id;

  driverName.value = v.name || "";
  plate.value = v.plate || "";
  driver.value = v.driver || "";
  iqama.value = v.iqama || "";
  license.value = v.license || "";
  inspectionDate.value = v.inspectionDate || "";
  expiryDate.value = v.expiryDate || "";
  medicalExpiryDate.value = v.medicalExpiryDate || "";
  serviceDate.value = v.serviceDate || "";
  nextServiceDate.value = v.nextServiceDate || "";

  image.value = "";
  docs.value = "";

  vehicleFormTitle.textContent = "Edit Vehicle";
  submitBtn.textContent = "Save Changes";

  window.scrollTo({ top: 0, behavior: "smooth" });
}

/* DELETE VEHICLE */
function deleteVehicle() {
  if (!currentVehicleId) return;

  const v = vehicles.find(x => x.id === currentVehicleId);
  const label = v ? (v.name || v.driver || v.plate || "this record") : "this record";

  if (!confirm(`Delete ${label}?`)) return;

  window.dbApi.dbDeleteVehicle(currentVehicleId).then(() => {
    vehicles = vehicles.filter(v => v.id !== currentVehicleId);
    currentVehicleId = null;
    isEditing = false;
    editingId = null;
    renderList();
    renderStats();
    detailsBody.style.display = "none";
    detailsTitle.textContent = "No vehicle selected";
    detailsSubtitle.textContent = "Select a vehicle to view details";
    vehicleForm.reset();
    vehicleFormTitle.textContent = "Add New Vehicle";
    submitBtn.textContent = "Add Vehicle";
  });
}

/* ADD / EDIT VEHICLE */
vehicleForm.onsubmit = function(e) {
  e.preventDefault();

  const editing = isEditing && editingId;

  const baseData = {
    name: driverName.value,
    plate: plate.value,
    driver: driver.value,
    iqama: iqama.value,
    license: license.value,
    inspectionDate: inspectionDate.value,
    expiryDate: expiryDate.value,
    medicalExpiryDate: medicalExpiryDate.value,
    serviceDate: serviceDate.value,
    nextServiceDate: nextServiceDate.value
  };

  const imageFiles = image.files;
  const docFiles = docs.files;

  let images = [];
  let docsArr = [];

  const existing = editing ? vehicles.find(v => v.id === editingId) : null;

  function finish() {
    const finalData = { ...baseData, images, docs: docsArr };

    if (editing) {
      window.dbApi.dbUpdateVehicle(editingId, finalData).then(() => {
        const idx = vehicles.findIndex(v => v.id === editingId);
        if (idx !== -1) {
          vehicles[idx] = { ...vehicles[idx], ...finalData };
        }
        renderList();
        renderStats();
        showDetails(editingId);
        isEditing = false;
        editingId = null;
        vehicleForm.reset();
        vehicleFormTitle.textContent = "Add New Vehicle";
        submitBtn.textContent = "Add Vehicle";
      });
    } else {
      window.dbApi.dbAddVehicle(finalData).then(saved => {
        vehicles.push(saved);
        renderList();
        renderStats();
        showDetails(saved.id);
        vehicleForm.reset();
      });
    }
  }

  function readDocs(done) {
    let out = [];
    if (!docFiles.length) {
      if (editing && existing && existing.docs) {
        out = existing.docs;
      }
      return done(out);
    }

    let remaining = docFiles.length;
    for (const file of docFiles) {
      const r = new FileReader();
      r.onload = () => {
        out.push({ name: file.name, dataUrl: r.result });
        if (--remaining === 0) done(out);
      };
      r.readAsDataURL(file);
    }
  }

  function readImages(done) {
    let out = [];
    if (!imageFiles.length) {
      if (editing && existing && existing.images) {
        out = existing.images;
      }
      return done(out);
    }

    let remaining = imageFiles.length;
    for (const file of imageFiles) {
      const r = new FileReader();
      r.onload = () => {
        out.push({ name: file.name, dataUrl: r.result });
        if (--remaining === 0) done(out);
      };
      r.readAsDataURL(file);
    }
  }

  readImages(imgArr => {
    images = imgArr;
    readDocs(docArr => {
      docsArr = docArr;
      finish();
    });
  });
};
</script>

</body>
</html>






